## 表格数据概览
##### R 语言的优势 (R's Strengths)
- 处理表格数据是 R 语言的一大优势 
- 其他优势：`ggplot2` 绘图、特定统计方法 
- 熟练掌握表格数据处理能提高生产力

##### 主要处理方式
- **Base-R**：内置 `data.frame`，配合 `subset()`, `within()`, `aggregate()` 等函数
    - **`data.frame` 本质**：一个列表（List），其元素（列）长度必须相同
    - **`data.frame` 局限性**：对于大型数据集速度较慢
- **`dplyr`/tidyverse**：使用 `tibble`，配合 `filter()`, `select()`, `mutate()` 等函数
- **`data.table`**：本单元重点学习的包
	- **特点**：更快、能更好地处理大数据 
    - **特点**：语法更简洁、原则性更强
    - **结构**：与 `data.frame` 类似，可轻松相互转换


## `data.table` 基础与 `[]` 运算符

##### 构造 `data.table` (Construction)
- 使用 `data.table()`, `as.data.table()` 
- 使用 `setDT()` 将 `data.frame` **原地**转换为 `data.table`
- 使用 `rbindlist()` 从行列表（lists of rows）中获取 `data.table`

##### 核心操作：`dt[i, j, by]`
- `data.table` 对 `[ ]` 运算符的使用与 `data.frame` **不同**
- 表达式格式：`dt[i, j]`（省略了 `by` 等参数）
- `i` 和 `j` 表达式都在 `data.table` **内部**求值
    - **例外**：`i` 为单个符号（external variable），`j` 为常量（constants）时

##### `i` 参数：行选择器 (The `i` Argument: Row Selector)
- **作用**：在 `data.table` 内部求值，选择行
- **选择方式**：
    1. **逻辑值** (`logical()`)：基于真值选择行（类似 `dplyr::filter()` 或 SQL `WHERE`）
        - 可使用 `&` 或 `|` 组合条件
        - `NA` 被视为 `FALSE` 
        - **辅助运算符**：`%like%` (类似 `grepl()`)，`%between%` (在两个值之间)
    2. **整数值** (`integer-valued numeric()`)：基于索引选择行（类似 `dplyr::slice()`） 
        - 常与 `order()`, `which.min()`, `which.max()`, `sample.int()` 结合使用 
    3. **连接** (Joins)：用于执行表格连接操作

##### `j` 参数：列/值构造器 (The `j` Argument: Column/Value Constructor)
- **作用**：在 `data.table` 内部求值，**构造新值** 
- **返回值类型**：
    1. **原子结果** (`atomic results`)：返回一个向量（Vector） 
    2. **列表结果** (`list results`)：返回一个 `data.table` 
        - `.()` 是 `list()` 的快捷方式 
- **列选择**：使用 `with = FALSE` 参数可以直接选择列名/索引 
- **动态性**：`j` 中的表达式可以调用外部变量，但列名变量优先

##### `j` 中的原地修改：`:=` 赋值 (In-Place Modification: `:=` Assignment)
- **目的**：用于在 `data.table` 内部创建或更新列 
- **操作方式**：
    - **创建/更新单列**：`dt[, new_col := expression]` 
    - **创建/更新多列**：`dt[, c("col1", "col2") := list(expr1, expr2)]` 或使用 `:=()` 
    - **动态赋值**：使用圆括号 `(...) := ...` 进行动态列名赋值 
    - **删除列**：将列赋值为 `NULL` 
    - **原地（In-place）**：`:=` 赋值会直接修改原始 `dt` 变量（引用语义） 
- **`i` 与 `j` 结合**：`dt[i, col := expr]` 只更新 `i` 选择的行 。新创建的列在未被更新的行上填充 `NA`

##### 立即打印 (Immediate Printing)
* 在原地操作（如 `:=` 赋值）后，追加 `[]` 可以立即打印结果，即使该操作本身是“不可见”的 (invisible)


## 复制语义与引用语义 (Copy Semantics vs. Reference Semantics)

##### R 的默认机制：写时复制 (Copy-on-Write)
- **机制**：变量之间共享内存地址，直到其中一个变量的值被修改时，R 才会进行复制操作 
- **特点**：效率高，同时保证用户友好性（函数调用不会意外改变原始变量） 
- **局限性**：修改列表/数据框中的一个值，可能会导致整个对象被复制，处理大数据时较浪费

##### `data.table` 的机制：引用语义 (Reference Semantics)
- **机制**：`data.table` 的原地操作（如 `:=` 赋值或 `set*` 函数）直接修改内存中的数据 
- **结果**：如果多个变量指向同一个 `data.table`，对其中任何一个变量进行原地修改，其他变量也会同时改变 
- **工具**：
    - `copy()`：用于创建不相连的副本 
    - `data.table::address()`：检查两个 `data.table` 是否指向同一内存地址 
    - **注意**：非 `set*` 函数或非 `[ := ]` 赋值的操作，仍会导致实际复制


## 高级功能 (Advanced Functionality)

##### 聚合 (Aggregation)
- 使用 `by =` 参数进行分组聚合 
- **特殊变量**：
    - `.N`：计算子组（subgroup）的行数 
    - `.SD`：子数据（Subset of Data），用于对子数据框进行高级聚合 
    - `.SDcols`：配合 `.SD` 使用，选择列 
    - `.BY`, `.GRP`, `.NGRP`, `.I`, `.EACHI`：其他用于高级控制的特殊变量
dddaddfdefeeeeee
##### 数据 I/O (Data Input/Output)
* `fread()` 和 `fwrite()`：用于快速读写大型文件

##### 合并与连接 (Merge/Join)
- **函数**：`merge()` 
- **`data.table` 连接**：`X[Y, ...]` 形式的连接 
- **连接类型**：需了解内连接 (inner), 左/右连接 (left/right), 外连接 (outer), 反连接 (anti join) 及其在 `data.table` 中的实现

##### 重塑 (Reshaping)
* `dcast()` 和 `melt()`：用于宽格式（wide）和长格式（long）之间的重塑

##### 键 (Keys)
- **作用**：实现自动排序、快速行子集和通过值进行行选择 (`X[<value>]`) 
- **函数**：
    - `key()`, `indices()`, `haskey()`：查看键/索引状态 
    - `setkey()` / `setindex()`：设置键/索引 
    - `setkeyv()` / `setindexv()`：通过变量名设置键/索引

##### 其他实用函数 (Other Utility Functions)
- **集合操作 (Set Operations)**：`fintersect()`, `fsetdiff()`, `funion()` 等，将 `data.table` 的行视为集合 
- **重复处理**：`duplicated()`, `unique()`, `anyDuplicated()`, `uniqueN()` (计算唯一行数) 
- **排序/排名**：`frank()`, `frankv()`, `setorder()`, `setorderv()` 
- **原地设置函数 (`set...()`)**：`setattr()`, `setnames()` (修改属性/名称), `setcolorder()` (重新排序列) 
- **行选择辅助**：`between()`, `inrange()`, `like()`, `flike()`, `ilike()` 
- **一般辅助函数**：`first()`, `last()`, `shift()` (滞后/超前向量), `tstrsplit()` (转置字符串拆分), `fcoalesce()` (返回第一个非 NA 值), `nafill()` (填充缺失值), `CJ()` (创建笛卡尔积/交叉连接)